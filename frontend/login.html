<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediFusion - Login</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles/auth.css">
</head>

<body>

    <div class="auth-container">
        <!-- Left Branding Panel -->
        <div class="auth-branding">
            <div class="brand-content">
                <a href="index.html" class="brand-logo">
                    <span class="brand-logo-icon">ü©∫</span> MediFusion
                </a>
                <h2 class="brand-tagline">Welcome Back to Your Health Dashboard</h2>
                <p class="brand-desc">Access AI-powered diagnostics, view your medical history, and connect with
                    specialists.</p>
                <div class="brand-features">
                    <div class="brand-feature">
                        <span class="brand-feature-icon">ü§ñ</span>
                        <span>AI-powered symptom analysis</span>
                    </div>
                    <div class="brand-feature">
                        <span class="brand-feature-icon">üìä</span>
                        <span>Real-time health monitoring</span>
                    </div>
                    <div class="brand-feature">
                        <span class="brand-feature-icon">üë®‚Äç‚öïÔ∏è</span>
                        <span>Connect with top specialists</span>
                    </div>
                    <div class="brand-feature">
                        <span class="brand-feature-icon">üîí</span>
                        <span>HIPAA-compliant security</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Form Panel -->
        <div class="auth-form-panel">
            <div class="auth-card">
                <div class="mobile-logo">
                    <a href="index.html">ü©∫ MediFusion</a>
                </div>

                <h2 class="title">Sign In</h2>
                <p class="subtitle">Enter your credentials to continue</p>

                <form id="loginForm">
                    <input type="text" id="username" placeholder="Username" required>
                    <input type="password" id="password" placeholder="Password" required>
                    <select id="role" required>
                        <option value="">Select Role</option>
                        <option value="patient">Patient</option>
                        <option value="doctor">Doctor</option>
                    </select>
                    <button class="btn-primary" type="submit">Sign In</button>
                </form>

                <p class="switch-text">
                    Don't have an account? <a href="signup.html">Create one</a>
                </p>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        document.getElementById("loginForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const submitBtn = document.querySelector("button[type='submit']");
            const originalBtnText = submitBtn.innerText;

            submitBtn.disabled = true;
            submitBtn.innerText = "Signing in...";

            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const role = document.getElementById("role").value;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({
                        username,
                        password,
                        scope: role
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    alert(data.detail || "Login failed. Invalid credentials.");
                    return;
                }

                localStorage.setItem("token", data.access_token);

                const userRes = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: { "Authorization": `Bearer ${data.access_token}` }
                });

                if (!userRes.ok) {
                    alert("Login successful but failed to fetch user details.");
                    return;
                }

                const userData = await userRes.json();
                localStorage.setItem("user", JSON.stringify(userData));

                if (userData.role === "patient") window.location.href = "patient_dashboard.html";
                else if (userData.role === "doctor") window.location.href = "doctor_dashboard.html";
                else if (userData.role === "lab" || userData.role === "labor" || userData.role === "lab_tech") window.location.href = "lab_dashboard.html";
                else alert("Unknown role. Contact admin.");

            } catch (err) {
                console.error(err);
                alert("Network error. Please check your backend connection.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
            }
        });
    </script>

</body>

</html>