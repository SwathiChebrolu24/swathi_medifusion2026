<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doctor Dashboard - MediFusion</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0e27;
      --bg-secondary: #0f1535;
      --bg-glass: rgba(255, 255, 255, 0.06);
      --border-glass: rgba(255, 255, 255, 0.08);
      --accent: #00d4aa;
      --accent-glow: rgba(0, 212, 170, 0.3);
      --accent2: #667eea;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-muted: rgba(255, 255, 255, 0.4);
      --gradient-accent: linear-gradient(135deg, #00d4aa, #00b894);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 260px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-glass);
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: transform 0.3s;
    }

    .sidebar-logo {
      font-family: 'Outfit', sans-serif;
      font-size: 22px;
      font-weight: 800;
      background: var(--gradient-accent);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 8px;
      margin-bottom: 12px;
      text-decoration: none;
    }

    .sidebar-logo-icon {
      width: 32px;
      height: 32px;
      background: var(--gradient-accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      -webkit-text-fill-color: white;
    }

    .sidebar-user {
      padding: 16px 12px;
      background: var(--bg-glass);
      border-radius: 12px;
      border: 1px solid var(--border-glass);
      margin-bottom: 24px;
    }

    .sidebar-user-name {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 2px;
    }

    .sidebar-user-role {
      font-size: 12px;
      color: var(--accent);
      font-weight: 500;
    }

    .sidebar-nav {
      flex: 1;
    }

    .sidebar-nav a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 10px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      transition: all 0.2s;
    }

    .sidebar-nav a:hover,
    .sidebar-nav a.active {
      background: rgba(0, 212, 170, 0.1);
      color: var(--accent);
    }

    .sidebar-nav a .icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    .sidebar-bottom {
      padding-top: 16px;
      border-top: 1px solid var(--border-glass);
    }

    .btn-logout {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 10px;
      color: #f56565;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      background: none;
      border: none;
      width: 100%;
      font-family: inherit;
      transition: background 0.2s;
    }

    .btn-logout:hover {
      background: rgba(245, 101, 101, 0.1);
    }

    /* ===== MAIN ===== */
    .main {
      margin-left: 260px;
      flex: 1;
      padding: 28px 32px;
      min-height: 100vh;
    }

    .page-header {
      margin-bottom: 28px;
    }

    .page-title {
      font-family: 'Outfit', sans-serif;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: 14px;
    }

    /* ===== STATS ===== */
    .stats-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(10px);
      transition: all 0.3s;
    }

    .stat-card:hover {
      border-color: rgba(0, 212, 170, 0.2);
      transform: translateY(-2px);
    }

    .stat-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-bottom: 14px;
    }

    .stat-icon.green {
      background: rgba(72, 187, 120, 0.15);
    }

    .stat-icon.blue {
      background: rgba(102, 126, 234, 0.15);
    }

    .stat-icon.orange {
      background: rgba(237, 137, 54, 0.15);
    }

    .stat-value {
      font-family: 'Outfit', sans-serif;
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* ===== TABS ===== */
    .tabs-container {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .tab-btn {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border-glass);
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-family: 'Inter', sans-serif;
    }

    .tab-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .tab-btn.active {
      background: var(--accent);
      color: #0a0e27;
      border-color: var(--accent);
    }

    .tab-badge {
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      background: rgba(255, 255, 255, 0.15);
    }

    .tab-btn.active .tab-badge {
      background: rgba(10, 14, 39, 0.2);
    }

    /* ===== CASES ===== */
    .cases-section {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      border-radius: 20px;
      padding: 28px;
      backdrop-filter: blur(10px);
    }

    .section-header {
      margin-bottom: 20px;
    }

    .section-header h2 {
      font-family: 'Outfit', sans-serif;
      font-size: 20px;
      font-weight: 700;
    }

    .cases-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
      gap: 16px;
    }

    .case-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-glass);
      border-radius: 14px;
      padding: 22px;
      border-left: 3px solid var(--accent);
      transition: all 0.3s;
    }

    .case-card:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-2px);
    }

    .case-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 14px;
    }

    .case-patient h3 {
      font-family: 'Outfit', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .case-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
    }

    .badge-type {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }

    .badge-severity-low {
      background: rgba(72, 187, 120, 0.2);
      color: #48bb78;
    }

    .badge-severity-medium {
      background: rgba(237, 137, 54, 0.2);
      color: #ed8936;
    }

    .badge-severity-high {
      background: rgba(245, 101, 101, 0.2);
      color: #f56565;
    }

    .case-details {
      margin-top: 12px;
    }

    .detail-row {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .detail-label {
      font-weight: 600;
      color: var(--text-muted);
    }

    .detail-value {
      color: var(--text-secondary);
    }

    .ai-analysis {
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      border-radius: 10px;
      margin-top: 12px;
      border-left: 3px solid var(--accent2);
    }

    .ai-analysis-label {
      font-weight: 700;
      color: var(--accent2);
      font-size: 12px;
      margin-bottom: 4px;
    }

    .ai-analysis-text {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .case-actions {
      display: flex;
      gap: 8px;
      margin-top: 0;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background: var(--gradient-accent);
      color: #0a0e27;
      box-shadow: 0 2px 10px var(--accent-glow);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.06);
      color: var(--text-secondary);
      border: 1px solid var(--border-glass);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* ===== REVIEW FORM ===== */
    .review-section {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      border-radius: 20px;
      padding: 28px;
      backdrop-filter: blur(10px);
      display: none;
    }

    .review-section.active {
      display: block;
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      font-family: 'Inter', sans-serif;
    }

    .back-btn:hover {
      text-decoration: underline;
    }

    .review-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .form-group {
      background: rgba(255, 255, 255, 0.03);
      padding: 20px;
      border-radius: 14px;
      border-left: 3px solid var(--accent);
    }

    .form-group h3 {
      font-family: 'Outfit', sans-serif;
      color: var(--accent);
      font-size: 15px;
      margin-bottom: 12px;
      font-weight: 700;
    }

    .readonly-box {
      background: rgba(255, 255, 255, 0.04);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid var(--border-glass);
      min-height: 80px;
      color: var(--text-secondary);
      line-height: 1.7;
      white-space: pre-wrap;
      font-size: 14px;
    }

    textarea,
    .review-input {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--border-glass);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
      transition: border-color 0.3s;
    }

    textarea:focus,
    .review-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    textarea::placeholder,
    .review-input::placeholder {
      color: var(--text-muted);
    }

    select {
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border-glass);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='rgba(255,255,255,0.4)' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }

    select option {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .btn-submit {
      width: 100%;
      background: var(--gradient-accent);
      color: #0a0e27;
      border: none;
      padding: 16px 40px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 16px;
      font-family: 'Inter', sans-serif;
      box-shadow: 0 4px 15px var(--accent-glow);
    }

    .btn-submit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--accent-glow);
    }

    .btn-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 52px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(10, 14, 39, 0.3);
      border-radius: 50%;
      border-top-color: #0a0e27;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ===== MOBILE ===== */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 14px 20px;
      background: rgba(10, 14, 39, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-glass);
      z-index: 200;
      align-items: center;
      justify-content: space-between;
    }

    .mobile-header .logo-text {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 20px;
      background: var(--gradient-accent);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hamburger {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding: 5px;
    }

    .hamburger span {
      width: 24px;
      height: 2px;
      background: var(--text-primary);
      border-radius: 2px;
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99;
    }

    @media (max-width: 1024px) {
      .cases-grid {
        grid-template-columns: 1fr;
      }

      .review-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .sidebar-overlay.open {
        display: block;
      }

      .mobile-header {
        display: flex;
      }

      .main {
        margin-left: 0;
        padding: 80px 16px 28px;
      }

      .stats-section {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <!-- Mobile Header -->
  <div class="mobile-header">
    <span class="logo-text">ü©∫ MediFusion</span>
    <button class="hamburger" onclick="toggleSidebar()">
      <span></span><span></span><span></span>
    </button>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <a href="index.html" class="sidebar-logo">
      <span class="sidebar-logo-icon">ü©∫</span> MediFusion
    </a>

    <div class="sidebar-user">
      <div class="sidebar-user-name">Dr. <span id="doctorName">Doctor</span></div>
      <div class="sidebar-user-role">Doctor</div>
    </div>

    <nav class="sidebar-nav">
      <a href="#" class="active"><span class="icon">üìä</span> Dashboard</a>
      <a href="#" onclick="switchTab('my')"><span class="icon">üìã</span> My Cases</a>
      <a href="#" onclick="switchTab('pool')"><span class="icon">üöÄ</span> Open Pool</a>
      <a href="#" onclick="switchTab('closed')"><span class="icon">‚úÖ</span> Closed Cases</a>
      <a href="index.html"><span class="icon">üè†</span> Home</a>
    </nav>

    <div class="sidebar-bottom">
      <button class="btn-logout" onclick="logout()">
        <span class="icon">üö™</span> Logout
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <div class="page-header">
      <h1 class="page-title">Doctor Dashboard</h1>
      <p class="page-subtitle">Review cases and manage patient care</p>
    </div>

    <!-- Stats -->
    <div class="stats-section">
      <div class="stat-card">
        <div class="stat-icon green">‚úÖ</div>
        <div class="stat-value" id="totalClosed">0</div>
        <div class="stat-label">Cases Closed</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon blue">üìã</div>
        <div class="stat-value" id="myAssignments">0</div>
        <div class="stat-label">My Assignments</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">üöÄ</div>
        <div class="stat-value" id="openPool">0</div>
        <div class="stat-label">Open Pool</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
      <button class="tab-btn active" onclick="switchTab('my')" id="tab-my">
        My Assignments <span class="tab-badge" id="badge-my">0</span>
      </button>
      <button class="tab-btn" onclick="switchTab('pool')" id="tab-pool">
        Open Pool <span class="tab-badge" id="badge-pool">0</span>
      </button>
      <button class="tab-btn" onclick="switchTab('closed')" id="tab-closed">
        Closed Cases <span class="tab-badge" id="badge-closed">0</span>
      </button>
    </div>

    <!-- Cases List View -->
    <div id="casesView" class="cases-section">
      <div class="section-header">
        <h2 id="listTitle">üìã My Assigned Cases</h2>
      </div>
      <div class="cases-grid" id="casesGrid">
        <div class="empty-state">
          <div class="empty-state-icon">‚è≥</div>
          <p style="font-size: 16px; font-weight: 600;">Loading cases...</p>
        </div>
      </div>
    </div>

    <!-- Review Form View -->
    <div id="reviewView" class="review-section">
      <button class="back-btn" onclick="showCasesList()">‚Üê Back to Cases</button>
      <h2 style="font-family:'Outfit',sans-serif; font-size:24px; font-weight:700; margin-bottom:24px;">Review Patient
        Case</h2>

      <div class="review-grid">
        <div class="form-group">
          <h3>üë§ Patient Information</h3>
          <div class="readonly-box" id="patientInfo">Loading...</div>
        </div>

        <div class="form-group">
          <h3>ü§ñ AI Analysis Result</h3>
          <div class="readonly-box" id="aiAnalysis">Loading...</div>
        </div>

        <div class="form-group">
          <h3>ü©∫ Diagnosis</h3>
          <input type="text" id="diagnosisInput" class="review-input"
            placeholder="Enter diagnosis (e.g., Pneumonia, Tuberculosis)" style="min-height:auto; padding:14px;">
        </div>

        <div class="form-group">
          <h3>üìù Doctor's Notes</h3>
          <textarea id="notesInput" rows="4" placeholder="Enter your clinical notes and recommendations..."></textarea>
        </div>

        <div class="form-group">
          <h3>üíä Prescribed Medicines</h3>
          <textarea id="medicinesInput" rows="3"
            placeholder="List prescribed medications (e.g., Amoxicillin 500mg, 3 times daily for 7 days)"></textarea>
        </div>

        <div class="form-group">
          <h3>üß™ Recommend Lab Test</h3>
          <div style="display: flex; gap: 10px;">
            <select id="testType" style="flex: 1;">
              <option value="">-- Select Test --</option>
              <option value="X-Ray">Chest X-Ray</option>
              <option value="Blood Test">Blood Test (CBC)</option>
              <option value="CT Scan">CT Scan</option>
              <option value="MRI">MRI</option>
              <option value="Sputum Test">Sputum Test</option>
            </select>
            <button class="btn btn-secondary" onclick="orderTest()" id="orderTestBtn">Order Test</button>
          </div>
          <p id="testStatusMsg"
            style="margin-top: 10px; font-size: 13px; color: var(--accent); font-weight: 600; display: none;">
          </p>
        </div>

        <div class="form-group" id="labReportSection" style="display: none;">
          <h3>üß™ Lab Report</h3>
          <div id="labReportLink"></div>
        </div>
      </div>

      <button class="btn-submit" onclick="submitReview()" id="submitBtn">
        Submit Review
      </button>
    </div>
  </main>

  <script src="config.js"></script>
  <script>
    // API_BASE_URL is loaded from config.js
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    let currentCaseId = null;
    let myCases = [];
    let poolCases = [];
    let closedCases = [];
    let activeTab = 'my';

    // Auth Check
    if (!token || user.role !== "doctor") {
      window.location.href = "login.html";
    }

    // Initialize
    document.getElementById("doctorName").innerText = user.full_name || user.username || "Doctor";
    fetchData();

    // Mobile sidebar toggle
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('open');
    }

    // WebSocket Connection
    let ws = null;

    connectWebSocket();
    function connectWebSocket() {
      if (!user.id || !token) return;

      const wsUrl = `${WS_BASE_URL}/ws/${user.id}?token=${token}`;
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('‚úÖ WebSocket connected');
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('üì® WebSocket message:', data);

        if (data.type === 'new_case') {
          showNotification('New case in pool!');
          fetchData();
        } else if (data.type === 'case_accepted') {
          showNotification('Case accepted successfully');
          fetchData();
        }
      };

      ws.onerror = (error) => {
        console.error('‚ùå WebSocket error:', error);
      };

      ws.onclose = () => {
        console.log('üîå WebSocket disconnected. Reconnecting in 5s...');
        setTimeout(connectWebSocket, 5000);
      };
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
                position: fixed; top: 20px; right: 20px;
                background: linear-gradient(135deg, #00d4aa, #00b894);
                color: #0a0e27; padding: 15px 25px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,212,170,0.3);
                z-index: 10000; font-weight: 600; font-size: 14px;
            `;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    function logout() {
      if (confirm("Are you sure you want to logout?")) {
        localStorage.clear();
        window.location.href = "login.html";
      }
    }

    function switchTab(tab) {
      activeTab = tab;
      document.getElementById('tab-my').classList.toggle('active', tab === 'my');
      document.getElementById('tab-pool').classList.toggle('active', tab === 'pool');
      document.getElementById('tab-closed').classList.toggle('active', tab === 'closed');

      if (tab === 'my') document.getElementById('listTitle').innerText = 'üìã My Assigned Cases';
      else if (tab === 'pool') document.getElementById('listTitle').innerText = 'üöÄ Open Pool - Available Cases';
      else if (tab === 'closed') document.getElementById('listTitle').innerText = '‚úÖ Closed Cases History';

      renderCases();
    }

    function showCasesList() {
      document.getElementById("reviewView").classList.remove("active");
      document.getElementById("casesView").style.display = "block";
      document.querySelector('.tabs-container').style.display = "flex";
      document.querySelector('.stats-section').style.display = "grid";
      fetchData();
    }

    async function fetchData() {
      await Promise.all([fetchCases(), fetchStats()]);
    }

    async function fetchStats() {
      try {
        const res = await fetch(`${API_BASE_URL}/doctor/stats`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('totalClosed').innerText = data.total_cases_closed;
        }
      } catch (e) { console.error(e); }
    }

    async function fetchCases() {
      const casesGrid = document.getElementById("casesGrid");
      casesGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚è≥</div><p>Loading...</p></div>';
      try {
        const res = await fetch(`${API_BASE_URL}/doctor/assigned`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        if (res.ok) {
          const data = await res.json();
          myCases = data.my_cases || [];
          poolCases = data.open_pool || [];
          closedCases = data.closed_cases || [];

          document.getElementById('badge-my').innerText = myCases.length;
          document.getElementById('badge-pool').innerText = poolCases.length;
          document.getElementById('badge-closed').innerText = closedCases.length;
          document.getElementById('myAssignments').innerText = myCases.length;
          document.getElementById('openPool').innerText = poolCases.length;

          renderCases();
        } else {
          casesGrid.innerHTML = '<div class="empty-state"><p style="color:#f56565;">Failed to load cases</p></div>';
        }
      } catch (err) {
        casesGrid.innerHTML = '<div class="empty-state"><p style="color:#f56565;">Network error</p></div>';
      }
    }

    function renderCases() {
      const casesGrid = document.getElementById("casesGrid");
      let cases = [];
      if (activeTab === 'my') cases = myCases;
      else if (activeTab === 'pool') cases = poolCases;
      else if (activeTab === 'closed') cases = closedCases;

      casesGrid.innerHTML = "";

      if (cases.length === 0) {
        casesGrid.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><p style="font-size:16px;font-weight:600;">No cases found</p></div>`;
        return;
      }

      cases.forEach(c => {
        const date = new Date(c.created_at).toLocaleDateString();
        const type = c.symptoms ? "Symptoms" : "X-Ray";
        const severity = c.severity_score || 0;
        let severityClass = severity < 3 ? "badge-severity-low" : (severity < 7 ? "badge-severity-medium" : "badge-severity-high");
        let severityText = severity < 3 ? "Low" : (severity < 7 ? "Medium" : "High");

        let aiResult = "Pending";
        if (c.xray_result) aiResult = c.xray_result.label || "Analyzed";
        else if (c.symptom_result) aiResult = c.symptom_result.label || "Analyzed";

        let actionBtn = "";
        if (activeTab === 'my') actionBtn = `<button class="btn btn-primary" onclick="openReview(${c.id})">üìù Review</button>`;
        else if (activeTab === 'pool') actionBtn = `<button class="btn btn-secondary" onclick="acceptCase(${c.id})">‚úÖ Accept</button>`;
        else actionBtn = `<button class="btn btn-secondary" onclick="openReview(${c.id})">üëÅÔ∏è View</button>`;

        const card = document.createElement("div");
        card.className = "case-card";
        card.innerHTML = `
              <div class="case-card-header">
                <div class="case-patient">
                  <h3>${c.patient_name || 'Unknown'}</h3>
                  <div class="case-meta">
                    <span style="color:var(--text-muted);font-size:12px;">üìÖ ${date}</span>
                    <span class="badge badge-type">${type}</span>
                    <span class="badge ${severityClass}">${severityText}</span>
                  </div>
                </div>
                <div class="case-actions">${actionBtn}</div>
              </div>
              <div class="case-details">
                <div class="detail-row"><div class="detail-label">Contact:</div><div class="detail-value">${c.patient_contact || 'N/A'}</div></div>
                ${c.symptoms ? `<div class="detail-row"><div class="detail-label">Symptoms:</div><div class="detail-value">${c.symptoms}</div></div>` : ''}
                <div class="ai-analysis"><div class="ai-analysis-label">ü§ñ AI Analysis</div><div class="ai-analysis-text">${aiResult}</div></div>
              </div>
            `;
        casesGrid.appendChild(card);
      });
    }

    async function acceptCase(caseId) {
      if (!confirm("Accept this case?")) return;
      try {
        const res = await fetch(`${API_BASE_URL}/doctor/cases/${caseId}/accept`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${token}` }
        });
        if (res.ok) {
          alert("‚úÖ Accepted!");
          fetchData();
          switchTab('my');
        } else alert("‚ùå Failed");
      } catch (e) { alert("‚ùå Error"); }
    }

    function openReview(caseId) {
      const c = myCases.find(x => x.id === caseId) || closedCases.find(x => x.id === caseId);
      if (!c) return;
      currentCaseId = caseId;
      document.getElementById("casesView").style.display = "none";
      document.querySelector('.tabs-container').style.display = "none";
      document.querySelector('.stats-section').style.display = "none";
      document.getElementById("reviewView").classList.add("active");
      document.getElementById("patientInfo").innerHTML = `
            <strong>Name:</strong> ${c.patient_name}<br>
            <strong>Contact:</strong> ${c.patient_contact || 'N/A'}<br>
            <strong>Symptoms:</strong> ${c.symptoms || 'None provided'}
          `;
      // AI Analysis Display
      let aiData = c.xray_result || c.symptom_result || {};
      let aiResult = "No AI analysis available";
      let analysisType = c.xray_result ? "X-Ray Analysis" : "Symptom Analysis";
      let chartId = `doctor-chart-${c.id}`;
      if (typeof aiData === 'object' && aiData.predictions) {
        const topPredictions = aiData.predictions.slice(0, 3);
        const predictionsList = topPredictions.map(p => `${p.disease}: ${(p.confidence * 100).toFixed(1)}%`).join('<br>');
        aiResult = `
                <strong>${analysisType}:</strong><br>${predictionsList}
                <div style="margin-top: 15px; height: 250px; width: 100;">
                    <canvas id="${chartId}"></canvas>
                </div>
            `;
      } else if (typeof aiData === 'object' && Object.keys(aiData).length > 0) {
        const label = aiData.top_label || aiData.label || "Unknown";
        const prob = aiData.top_prob || aiData.prob || 0;
        aiResult = `<strong>${analysisType}:</strong> ${label} (${(prob * 100).toFixed(1)}% confidence)`;
      } else if (typeof aiData === 'string') {
        aiResult = `<strong>${analysisType}:</strong> ${aiData}`;
      }

      const aiContainer = document.getElementById("aiAnalysis");
      aiContainer.innerHTML = aiResult;
      // Render Chart if predictions exist
      if (typeof aiData === 'object' && aiData.predictions) {
        setTimeout(() => {
          const ctx = document.getElementById(chartId);
          if (ctx) {
            const updates = aiData.predictions.slice(0, 5);
            new Chart(ctx.getContext('2d'), {
              type: 'bar',
              data: {
                labels: updates.map(p => p.disease),
                datasets: [{
                  label: 'Confidence (%)',
                  data: updates.map(p => (p.confidence * 100).toFixed(1)),
                  backgroundColor: 'rgba(0, 212, 170, 0.4)',
                  borderColor: 'rgba(0, 212, 170, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                  y: {
                    beginAtZero: true, max: 100,
                    ticks: { color: 'rgba(255,255,255,0.5)' },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                  },
                  x: {
                    ticks: { color: 'rgba(255,255,255,0.5)' },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                  }
                }
              }
            });
          }
        }, 100);
      }
      // Lab Report
      if (c.report_file) {
        document.getElementById("labReportSection").style.display = "block";
        document.getElementById("labReportLink").innerHTML = `<a href="${API_BASE_URL}/${c.report_file}" target="_blank" style="color: var(--accent); font-weight: 600; text-decoration: underline;">üìÑ View Lab Report (${c.ordered_test_type})</a>`;
      } else {
        document.getElementById("labReportSection").style.display = "none";
      }
      // Clear/load form
      document.getElementById("notesInput").value = c.doctor_notes || "";
      document.getElementById("medicinesInput").value = "";
      document.getElementById("diagnosisInput").value = c.diagnosis || "";
      document.getElementById("testType").value = "";
      document.getElementById("testStatusMsg").style.display = "none";
    }

    async function orderTest() {
      if (!currentCaseId) return;
      const testType = document.getElementById("testType").value;
      if (!testType) { alert("Please select a test type"); return; }
      const btn = document.getElementById("orderTestBtn");
      const msg = document.getElementById("testStatusMsg");
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Ordering...';
      try {
        const res = await fetch(`${API_BASE_URL}/doctor/cases/${currentCaseId}/order-test`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ test_type: testType })
        });
        if (res.ok) {
          msg.style.display = "block";
          msg.innerText = `‚úÖ ${testType} ordered successfully!`;
          setTimeout(() => msg.style.display = "none", 5000);
        } else {
          const result = await res.json();
          alert("‚ùå " + (result.detail || "Failed to order test"));
        }
      } catch (err) { alert("‚ùå Network error"); }
      finally { btn.disabled = false; btn.innerHTML = originalText; }
    }

    async function submitReview() {
      if (!currentCaseId) return;
      const diagnosis = document.getElementById("diagnosisInput").value.trim();
      const notes = document.getElementById("notesInput").value.trim();
      const medicines = document.getElementById("medicinesInput").value.trim();
      if (!diagnosis) { alert("‚ö†Ô∏è Please enter a diagnosis"); return; }
      const btn = document.getElementById("submitBtn");
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Submitting...';
      let finalNotes = notes;
      if (medicines) finalNotes += `\n\nPrescribed Medicines:\n${medicines}`;
      try {
        const res = await fetch(`${API_BASE_URL}/doctor/review/${currentCaseId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ diagnosis: diagnosis, notes: finalNotes, severity_score: 5.0 })
        });
        if (res.ok) {
          alert("‚úÖ Review submitted successfully!");
          showCasesList();
        } else {
          const result = await res.json();
          alert("‚ùå " + (result.detail || "Failed to submit review"));
        }
      } catch (err) { alert("‚ùå Network error"); }
      finally { btn.disabled = false; btn.innerHTML = originalText; }
    }
  </script>
</body>

</html>